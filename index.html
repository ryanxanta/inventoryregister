<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 50;
        }

        .modal.active {
            display: flex;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>
</head>

<body class="bg-gray-50">
    <!-- Header -->
    <div class="bg-blue-600 text-white p-4 sticky top-0 z-40 shadow-lg">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <svg width="28" height="28" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                </svg>
                <div>
                    <h1 class="text-xl font-bold">Inventory</h1>
                    <p class="text-xs text-blue-100">ID: <span id="mobileIdDisplay">--</span> | <span
                            id="itemCount">0</span> items</p>
                </div>
            </div>
            <button onclick="toggleMenu()" class="p-2 hover:bg-blue-700 rounded-lg transition">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
            </button>
        </div>
    </div>

    <!-- Dropdown Menu -->
    <div id="dropdownMenu" class="hidden absolute top-16 right-4 bg-white rounded-lg shadow-xl z-50 w-48">
        <button onclick="showMobileIdModal()"
            class="w-full flex items-center gap-3 px-4 py-3 hover:bg-gray-50 border-b border-gray-100">
            <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" />
            </svg>
            <span>Set Mobile ID</span>
        </button>
        <button onclick="exportJSON()"
            class="w-full flex items-center gap-3 px-4 py-3 hover:bg-gray-50 border-b border-gray-100">
            <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
            <span>Export JSON (with images)</span>
        </button>
        <button onclick="exportCSV()"
            class="w-full flex items-center gap-3 px-4 py-3 hover:bg-gray-50 border-b border-gray-100">
            <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
            <span>Export CSV</span>
        </button>
        <button onclick="exportZIP()" class="w-full flex items-center gap-3 px-4 py-3 hover:bg-gray-50">
            <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
            <span>Export ZIP (CSV + Images)</span>
        </button>
    </div>

    <!-- Items List -->
    <div class="p-4 pb-24">
        <div id="emptyState" class="bg-white rounded-xl p-8 text-center mt-20">
            <svg width="64" height="64" class="mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor"
                viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
            </svg>
            <h2 class="text-xl font-semibold text-gray-800 mb-2">No Items Yet</h2>
            <p class="text-gray-500 mb-6">Start adding items to your inventory</p>
            <button onclick="showAddForm()" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-medium">
                Add First Item
            </button>
        </div>
        <div id="itemsList" class="space-y-3 hidden"></div>
    </div>

    <!-- Floating Add Button -->
    <button onclick="showAddForm()"
        class="fixed bottom-6 right-6 bg-blue-600 text-white p-4 rounded-full shadow-2xl hover:bg-blue-700 transition z-30">
        <svg width="28" height="28" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
    </button>

    <!-- Mobile ID Modal -->
    <div id="mobileIdModal" class="modal items-center justify-center">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm m-4">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Set Mobile ID</h2>
            <p class="text-gray-600 mb-4">Enter your 2-digit Mobile ID. This will be used as the first 2 digits of all
                item codes.</p>

            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Mobile ID (2 digits)</label>
                <input type="text" id="mobileIdInput" maxlength="2" pattern="[0-9]{2}"
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-2xl text-center font-bold"
                    placeholder="00">
            </div>

            <div class="flex gap-3">
                <button onclick="closeMobileIdModal()"
                    class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-semibold hover:bg-gray-300 transition">
                    Cancel
                </button>
                <button onclick="saveMobileId()"
                    class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-semibold hover:bg-blue-700 transition">
                    Save
                </button>
            </div>
        </div>
    </div>

    <!-- Add Item Modal -->
    <div id="addModal" class="modal items-end sm:items-center justify-center">
        <div class="bg-white w-full sm:max-w-lg sm:rounded-t-3xl rounded-t-3xl max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b border-gray-200 p-4 flex items-center justify-between">
                <h2 class="text-xl font-bold text-gray-800">Add New Item</h2>
                <button onclick="closeAddForm()" class="p-2 hover:bg-gray-100 rounded-full">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <div class="p-4 space-y-4">
                <!-- Photo Section -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Product Photo</label>
                    <div id="photoPreview" class="hidden relative">
                        <img id="previewImage" src="" alt="Preview" class="w-full h-48 object-cover rounded-xl">
                        <button onclick="removePhoto()"
                            class="absolute top-2 right-2 bg-red-600 text-white p-2 rounded-full shadow-lg">
                            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <button id="photoButton" onclick="startCamera()"
                        class="w-full flex flex-col items-center justify-center gap-2 bg-blue-50 border-2 border-dashed border-blue-300 rounded-xl py-12 hover:bg-blue-100 transition">
                        <svg width="32" height="32" class="text-blue-600" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        <span class="text-blue-600 font-medium">Take Photo</span>
                    </button>
                </div>

                <!-- Item Name -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Item Name <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="itemName"
                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-base"
                        placeholder="Enter item name">
                </div>

                <!-- Quantity -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Quantity <span class="text-red-500">*</span>
                    </label>
                    <input type="number" id="itemQty" min="0"
                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-base"
                        placeholder="Enter quantity">
                </div>

                <!-- Item Code -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Item Code</label>
                    <div class="flex gap-2">
                        <input type="text" id="itemCode" maxlength="13"
                            class="flex-1 px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-base"
                            placeholder="Auto-generated" readonly>
                        <button onclick="generateCode()"
                            class="px-4 py-3 bg-gray-100 text-gray-700 rounded-xl font-medium hover:bg-gray-200">
                            Generate
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">First 2 digits: <span id="codePrefix"
                            class="font-semibold">--</span> (Mobile ID)</p>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-3 pt-4">
                    <button onclick="closeAddForm()"
                        class="flex-1 bg-gray-200 text-gray-700 py-4 rounded-xl font-semibold hover:bg-gray-300 transition">
                        Cancel
                    </button>
                    <button onclick="addItem()"
                        class="flex-1 bg-blue-600 text-white py-4 rounded-xl font-semibold hover:bg-blue-700 transition">
                        Add Item
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Camera Modal -->
    <div id="cameraModal" class="modal">
        <div class="flex-1 flex flex-col bg-black">
            <div class="flex-1 relative">
                <video id="cameraVideo" autoplay playsinline></video>
                <canvas id="canvas" class="hidden"></canvas>
            </div>

            <div class="bg-black bg-opacity-75 p-6">
                <div class="flex gap-4 justify-center">
                    <button onclick="stopCamera()"
                        class="px-8 py-4 bg-gray-600 text-white rounded-xl font-semibold hover:bg-gray-700 transition">
                        Cancel
                    </button>
                    <button onclick="capturePhoto()"
                        class="px-8 py-4 bg-white text-gray-900 rounded-xl font-semibold hover:bg-gray-100 transition flex items-center gap-2">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        Capture
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let items = JSON.parse(localStorage.getItem('inventoryItems')) || [];
        let stream = null;
        let currentPhoto = null;
        let mobileId = localStorage.getItem('mobileId') || '';

        // Initialize Mobile ID display
        function updateMobileIdDisplay() {
            const display = mobileId || '--';
            document.getElementById('mobileIdDisplay').textContent = display;
            document.getElementById('codePrefix').textContent = display;

            // Show modal if no Mobile ID set
            if (!mobileId) {
                setTimeout(() => showMobileIdModal(), 500);
            }
        }

        // Show Mobile ID modal
        function showMobileIdModal() {
            document.getElementById('mobileIdInput').value = mobileId;
            document.getElementById('mobileIdModal').classList.add('active');
            document.getElementById('dropdownMenu').classList.add('hidden');
        }

        // Close Mobile ID modal
        function closeMobileIdModal() {
            document.getElementById('mobileIdModal').classList.remove('active');
        }

        // Save Mobile ID
        function saveMobileId() {
            const input = document.getElementById('mobileIdInput').value.trim();

            if (input.length !== 2 || !/^\d{2}$/.test(input)) {
                alert('Please enter exactly 2 digits (00-99)');
                return;
            }

            mobileId = input;
            localStorage.setItem('mobileId', mobileId);
            updateMobileIdDisplay();
            closeMobileIdModal();
        }

        // Generate random 13-digit code with Mobile ID prefix
        function generateItemCode() {
            if (!mobileId) {
                alert('Please set your Mobile ID first');
                showMobileIdModal();
                return '';
            }

            let code = mobileId;
            for (let i = 0; i < 11; i++) {
                code += Math.floor(Math.random() * 10);
            }
            return code;
        }

        // Generate code button
        function generateCode() {
            const code = generateItemCode();
            if (code) {
                document.getElementById('itemCode').value = code;
            }
        }

        // Toggle menu
        function toggleMenu() {
            const menu = document.getElementById('dropdownMenu');
            menu.classList.toggle('hidden');
        }

        // Show add form
        function showAddForm() {
            if (!mobileId) {
                alert('Please set your Mobile ID first');
                showMobileIdModal();
                return;
            }
            document.getElementById('addModal').classList.add('active');
            document.getElementById('dropdownMenu').classList.add('hidden');
            // Auto-generate code when opening form
            generateCode();
        }

        // Close add form
        function closeAddForm() {
            document.getElementById('addModal').classList.remove('active');
            document.getElementById('itemName').value = '';
            document.getElementById('itemQty').value = '';
            document.getElementById('itemCode').value = '';
            removePhoto();
        }

        // Start camera
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                document.getElementById('cameraVideo').srcObject = stream;
                document.getElementById('cameraModal').classList.add('active');
            } catch (err) {
                alert('Camera access denied or not available: ' + err.message);
            }
        }

        // Stop camera
        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            document.getElementById('cameraModal').classList.remove('active');
        }

        // Capture photo
        function capturePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('canvas');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);

            currentPhoto = canvas.toDataURL('image/jpeg');
            document.getElementById('previewImage').src = currentPhoto;
            document.getElementById('photoPreview').classList.remove('hidden');
            document.getElementById('photoButton').classList.add('hidden');

            stopCamera();
        }

        // Remove photo
        function removePhoto() {
            currentPhoto = null;
            document.getElementById('photoPreview').classList.add('hidden');
            document.getElementById('photoButton').classList.remove('hidden');
        }

        // Add item
        function addItem() {
            const name = document.getElementById('itemName').value.trim();
            const qty = document.getElementById('itemQty').value.trim();
            const code = document.getElementById('itemCode').value.trim();

            if (!name || !qty) {
                alert('Please fill in all required fields');
                return;
            }

            if (!code || code.length !== 13) {
                alert('Please generate a valid 13-digit item code');
                return;
            }

            const item = {
                id: Date.now(),
                name: name,
                qty: parseInt(qty),
                itemCode: code,
                image: currentPhoto,
                createdAt: new Date().toISOString(),
                mobileId: mobileId
            };

            items.push(item);
            localStorage.setItem('inventoryItems', JSON.stringify(items));
            renderItems();
            closeAddForm();
        }

        // Delete item
        function deleteItem(id) {
            if (confirm('Are you sure you want to delete this item?')) {
                items = items.filter(item => item.id !== id);
                localStorage.setItem('inventoryItems', JSON.stringify(items));
                renderItems();
            }
        }

        // Render items
        function renderItems() {
            const itemsList = document.getElementById('itemsList');
            const emptyState = document.getElementById('emptyState');
            const itemCount = document.getElementById('itemCount');

            itemCount.textContent = items.length;

            if (items.length === 0) {
                itemsList.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            itemsList.classList.remove('hidden');

            itemsList.innerHTML = items.map(item => `
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="flex">
                        ${item.image ?
                    `<img src="${item.image}" alt="${item.name}" class="w-24 h-24 object-cover">` :
                    `<div class="w-24 h-24 bg-gray-100 flex items-center justify-center">
                                <svg width="32" height="32" class="text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                                </svg>
                            </div>`
                }
                        <div class="flex-1 p-3">
                            <h3 class="font-bold text-lg text-gray-800 mb-1">${item.name}</h3>
                            <p class="text-sm text-gray-500 mb-1">Code: ${item.itemCode}</p>
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium text-blue-600">Qty: ${item.qty}</span>
                                <button onclick="deleteItem(${item.id})" class="p-2 text-red-500 hover:bg-red-50 rounded-lg">
                                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Export JSON (with images as base64)
        function exportJSON() {
            const dataStr = JSON.stringify(items, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `inventory_${mobileId}_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            toggleMenu();
        }

        // Export CSV (without images)
        function exportCSV() {
            const headers = ['Item Code', 'Name', 'Quantity', 'Mobile ID', 'Created At', 'Has Image'];
            const csvContent = [
                headers.join(','),
                ...items.map(item =>
                    [item.itemCode, `"${item.name}"`, item.qty, item.mobileId, item.createdAt, item.image ? 'Yes' : 'No'].join(',')
                )
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `inventory_${mobileId}_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            URL.revokeObjectURL(url);
            toggleMenu();
        }

        // Export ZIP (CSV + Images)
        async function exportZIP() {
            if (items.length === 0) {
                alert('No items to export');
                toggleMenu();
                return;
            }

            try {
                const zip = new JSZip();
                const imagesFolder = zip.folder('images');

                // Create CSV content with image filenames
                const headers = ['Item Code', 'Name', 'Quantity', 'Mobile ID', 'Created At', 'Image Filename'];
                const csvRows = [headers.join(',')];

                // Add each item to CSV and its image to ZIP
                for (let i = 0; i < items.length; i++) {
                    const item = items[i];
                    let imageFilename = '';

                    // Add image to ZIP if it exists
                    if (item.image) {
                        imageFilename = `${item.itemCode}_${item.name.replace(/[^a-z0-9]/gi, '_')}.jpg`;
                        // Convert base64 to binary
                        const base64Data = item.image.split(',')[1];
                        imagesFolder.file(imageFilename, base64Data, { base64: true });
                    }

                    // Add row to CSV
                    csvRows.push([
                        item.itemCode,
                        `"${item.name}"`,
                        item.qty,
                        item.mobileId,
                        item.createdAt,
                        imageFilename
                    ].join(','));
                }

                // Add CSV to ZIP
                const csvContent = csvRows.join('\n');
                zip.file(`inventory_${mobileId}.csv`, csvContent);

                // Generate and download ZIP
                const content = await zip.generateAsync({ type: 'blob' });
                const url = URL.createObjectURL(content);
                const link = document.createElement('a');
                link.href = url;
                link.download = `inventory_${mobileId}_${new Date().toISOString().split('T')[0]}.zip`;
                link.click();
                URL.revokeObjectURL(url);

                toggleMenu();
            } catch (error) {
                alert('Error creating ZIP file: ' + error.message);
                console.error('ZIP export error:', error);
            }
        }

        // Close menu when clicking outside
        document.addEventListener('click', function (e) {
            const menu = document.getElementById('dropdownMenu');
            if (!e.target.closest('#dropdownMenu') && !e.target.closest('button[onclick="toggleMenu()"]')) {
                menu.classList.add('hidden');
            }
        });

        // Initialize
        updateMobileIdDisplay();
        renderItems();
    </script>
</body>

</html>
